<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#FFFFFF">
<title>ePunch — QR Split</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --coral: #FF385C;
  --coral-light: #FFF0F3;
  --coral-mid: #FFE4E9;
  --black: #222222;
  --gray-1: #484848;
  --gray-2: #717171;
  --gray-3: #B0B0B0;
  --gray-4: #DDDDDD;
  --gray-5: #F7F7F7;
  --white: #FFFFFF;
  --green: #008A05;
  --green-light: #E6F7E6;
  --gold: #E8A317;
  --gold-light: #FFF8E7;
  --nav-height: 68px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
  background: var(--white);
  color: var(--black);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}
body {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ── App Shell ── */
.app {
  width: 100%;
  min-height: 100vh;
  position: relative;
  padding-bottom: calc(var(--nav-height) + 16px + env(safe-area-inset-bottom, 0px));
}

/* ── Tab Views ── */
.tab-view { display: none; }
.tab-view.active { display: block; }

/* ── QR Card (split row — info left, QR right) ── */
.qr-top-card {
  margin: calc(8px + env(safe-area-inset-top, 0px)) 20px 0;
  padding: 14px 16px;
  background: var(--white);
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-direction: row;
}
.qr-top-info {
  flex: 1;
  min-width: 0;
}
.qr-canvas-container {
  width: 100px;
  height: 100px;
  background: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  order: 2;
}
.qr-top-logo {
  font-size: 22px;
  font-weight: 800;
  color: var(--coral);
  letter-spacing: -0.5px;
  margin-bottom: 2px;
}
.qr-top-logo span { color: var(--black); }
.qr-top-id {
  font-size: 10px;
  font-weight: 600;
  color: var(--gray-3);
  font-family: 'Plus Jakarta Sans', monospace;
  letter-spacing: 0.3px;
  margin-bottom: 8px;
}
.qr-top-hint {
  display: inline-block;
  font-size: 12px;
  font-weight: 600;
  color: var(--coral);
  background: var(--coral-light);
  padding: 6px 14px;
  border-radius: 20px;
}

/* ── Guest Banner ── */
.guest-banner {
  margin: 12px 20px 0;
  padding: 14px 16px;
  background: var(--coral-light);
  border-radius: 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.guest-banner-icon {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--coral);
  color: var(--white);
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 1px;
}
.guest-banner-text {
  font-size: 13px;
  line-height: 1.45;
  color: var(--gray-1);
}
.guest-banner-text strong { color: var(--black); }
.guest-banner-text a {
  color: var(--coral);
  font-weight: 600;
  text-decoration: underline;
  text-underline-offset: 2px;
}

/* ── Section Header ── */
.section-header {
  padding: 24px 20px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.section-title {
  font-size: 22px;
  font-weight: 800;
  color: var(--black);
  letter-spacing: -0.3px;
}
.section-count {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-2);
  background: var(--gray-5);
  padding: 4px 12px;
  border-radius: 20px;
}
.section-header-right {
  display: flex;
  align-items: center;
  gap: 6px;
}
.rewards-filter {
  display: none;
  font-size: 13px;
  font-weight: 700;
  color: var(--coral);
  background: var(--coral-light);
  padding: 4px 12px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  font-family: inherit;
}
.rewards-filter.visible { display: block; }
.rewards-filter.active {
  background: var(--coral);
  color: var(--white);
}

/* ── Cards List ── */
.cards-list { padding: 0 20px 20px; display: flex; flex-direction: column; gap: 12px; }

/* ── Card Item ── */
.card-item {
  background: var(--white);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
  border: 1px solid #F0F0F0;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.card-item::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--accent-color, var(--gray-3));
  border-radius: 4px 0 0 4px;
}

.card-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.card-emoji {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}
.card-info { flex: 1; min-width: 0; }
.card-shop {
  font-size: 15px;
  font-weight: 700;
  color: var(--black);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-program {
  font-size: 12px;
  color: var(--gray-2);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-type-badge {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 3px 8px;
  border-radius: 6px;
  flex-shrink: 0;
}
.badge-punch { background: var(--gray-5); color: var(--gray-2); }
.badge-bundle { background: #EDE7F6; color: #7B5EA7; }
.badge-benefit { background: var(--gold-light); color: #B8860B; }

/* Punch progress */
.punch-progress {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-wrap: wrap;
}
.punch-dot {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 2px solid var(--gray-4);
  position: relative;
}
.punch-dot.filled {
  border-color: transparent;
}
.punch-dot.filled::after {
  content: '\2713';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--white);
  border-radius: 50%;
}
.punch-count {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-2);
  margin-left: auto;
  flex-shrink: 0;
}

/* Reward ready badge */
.reward-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 10px;
  padding: 6px 12px;
  background: var(--green-light);
  color: var(--green);
  font-size: 12px;
  font-weight: 700;
  border-radius: 20px;
}
.reward-badge::before {
  content: '\2605';
  font-size: 12px;
}

/* Bundle progress */
.bundle-progress {
  display: flex;
  align-items: center;
  gap: 12px;
}
.bundle-bar-wrap { flex: 1; }
.bundle-bar {
  height: 8px;
  background: var(--gray-5);
  border-radius: 4px;
  overflow: hidden;
}
.bundle-bar-fill {
  height: 100%;
  border-radius: 4px;
}
.bundle-label {
  font-size: 12px;
  color: var(--gray-2);
  margin-top: 4px;
}
.bundle-count {
  font-size: 24px;
  font-weight: 800;
  line-height: 1;
  flex-shrink: 0;
}
.bundle-count-sub {
  font-size: 10px;
  font-weight: 600;
  color: var(--gray-2);
  text-align: center;
}

/* Benefit */
.benefit-desc {
  font-size: 16px;
  font-weight: 700;
  color: var(--black);
  margin-bottom: 8px;
}
.benefit-status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
}
.benefit-status.active {
  background: var(--green-light);
  color: var(--green);
}
.benefit-status.expired {
  background: var(--gray-5);
  color: var(--gray-3);
}
.benefit-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}
.benefit-status.active .benefit-status-dot { background: var(--green); }
.benefit-status.expired .benefit-status-dot { background: var(--gray-3); }

.card-item.expired-card { opacity: 0.55; }

/* ── History ── */
.history-section { padding: 0 20px 20px; }
.history-group-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gray-3);
  padding: 20px 0 8px;
}
.history-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid var(--gray-5);
}
.history-item:last-child { border-bottom: none; }
.history-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.history-content { flex: 1; min-width: 0; }
.history-text {
  font-size: 14px;
  font-weight: 500;
  color: var(--black);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.history-time {
  font-size: 12px;
  color: var(--gray-3);
  margin-top: 2px;
}

/* ── Profile ── */
.profile-section { padding: 0 20px 20px; }
.profile-card {
  background: var(--gray-5);
  border-radius: 20px;
  padding: 24px;
  margin-top: 16px;
}
.profile-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--coral-light);
  color: var(--coral);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  font-weight: 800;
  margin-bottom: 16px;
}
.profile-name {
  font-size: 20px;
  font-weight: 800;
  color: var(--black);
  margin-bottom: 4px;
}
.profile-sub {
  font-size: 13px;
  color: var(--gray-2);
  margin-bottom: 20px;
}
.profile-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 0;
  border-top: 1px solid var(--gray-4);
}
.profile-row-label {
  font-size: 14px;
  color: var(--gray-2);
}
.profile-row-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--black);
}
.profile-signin-btn {
  width: 100%;
  margin-top: 20px;
  padding: 16px;
  background: var(--coral);
  color: var(--white);
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

/* ── Bottom Nav ── */
.bottom-nav {
  position: fixed;
  bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  left: calc(16px + env(safe-area-inset-left, 0px));
  right: calc(16px + env(safe-area-inset-right, 0px));
  display: flex;
  justify-content: center;
  gap: 8px;
  z-index: 50;
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 10px 24px;
  border: none;
  background: rgba(255,255,255,0.45);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 16px;
  font-family: inherit;
}
.nav-item svg { color: var(--gray-3); }
.nav-item.active svg { color: var(--coral); }
.nav-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--gray-3);
}
.nav-item.active .nav-label { color: var(--coral); }

/* ── Modal Backdrop ── */
.modal-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: flex-end;
}
.modal-backdrop.visible { display: flex; }

.modal-handle {
  width: 36px;
  height: 4px;
  background: var(--gray-4);
  border-radius: 2px;
  margin: 0 auto 20px;
}

/* ── Card Detail Modal ── */
.detail-sheet {
  width: 100%;
  background: var(--white);
  border-radius: 24px 24px 0 0;
  padding: 20px 20px 40px;
  max-height: 90vh;
  overflow-y: auto;
}
.detail-header {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 20px;
}
.detail-emoji {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}
.detail-shop {
  font-size: 20px;
  font-weight: 800;
  color: var(--black);
}
.detail-address {
  font-size: 13px;
  color: var(--gray-2);
  margin-top: 2px;
}
.detail-address a { color: var(--coral); text-decoration: none; font-weight: 600; }

.detail-section {
  padding: 16px 0;
  border-top: 1px solid var(--gray-5);
}
.detail-section-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gray-3);
  margin-bottom: 10px;
}
.detail-program {
  font-size: 15px;
  color: var(--gray-1);
  line-height: 1.5;
}
.detail-reward {
  font-size: 15px;
  font-weight: 600;
  color: var(--black);
}
.detail-progress-dots {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}
.detail-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--gray-4);
}
.detail-dot.filled {
  border-color: transparent;
}
.detail-dot.filled::after {
  content: '\2713';
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font-size: 13px;
  font-weight: 700;
  color: var(--white);
  border-radius: 50%;
}
.detail-progress-text {
  font-size: 14px;
  color: var(--gray-2);
  font-weight: 500;
}
.detail-bar {
  height: 10px;
  background: var(--gray-5);
  border-radius: 5px;
  overflow: hidden;
  margin-bottom: 8px;
}
.detail-bar-fill {
  height: 100%;
  border-radius: 5px;
}
.detail-benefit-text {
  font-size: 18px;
  font-weight: 700;
  color: var(--black);
  margin-bottom: 12px;
}

.redeem-btn {
  width: 100%;
  padding: 16px;
  background: var(--coral);
  color: var(--white);
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  margin-top: 8px;
}
.close-btn {
  width: 100%;
  padding: 16px;
  background: var(--gray-5);
  color: var(--black);
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  margin-top: 8px;
}

/* ── Redeem Modal ── */
.redeem-sheet {
  width: 100%;
  background: var(--white);
  border-radius: 24px 24px 0 0;
  padding: 20px 20px 40px;
  text-align: center;
}
.redeem-label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--coral);
  background: var(--coral-light);
  padding: 6px 14px;
  border-radius: 20px;
  margin-bottom: 16px;
}
.redeem-shop {
  font-size: 20px;
  font-weight: 800;
  color: var(--black);
  margin-bottom: 4px;
}
.redeem-reward {
  font-size: 14px;
  color: var(--gray-2);
  margin-bottom: 24px;
}
.redeem-qr-wrap {
  width: 200px;
  height: 200px;
  margin: 0 auto 16px;
  background: var(--white);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 16px rgba(0,0,0,0.06);
  border: 1px solid var(--gray-5);
}
.redeem-warning {
  font-size: 12px;
  color: var(--gray-2);
  margin: 16px 0 20px;
  line-height: 1.5;
}
.redeem-cancel-btn {
  width: 100%;
  padding: 16px;
  background: var(--gray-5);
  color: var(--black);
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

/* ── Empty state ── */
.empty-state {
  display: none;
  padding: 32px 20px;
}
.empty-title {
  font-size: 17px;
  font-weight: 800;
  color: var(--black);
  margin-bottom: 20px;
}
.empty-steps {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.empty-step {
  display: flex;
  align-items: center;
  gap: 14px;
}
.empty-step-num {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--coral-light);
  color: var(--coral);
  font-size: 14px;
  font-weight: 800;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.empty-step-text {
  font-size: 14px;
  color: var(--gray-1);
  line-height: 1.4;
}
.empty-step-text strong {
  color: var(--black);
  font-weight: 700;
}
</style>
</head>
<body>

<div class="app">
    <!-- Cards Tab -->
    <div class="tab-view active" id="tabCards">
      <!-- QR Code split row: info left, QR right -->
      <div class="qr-top-card">
        <div class="qr-top-info">
          <div class="qr-top-logo">e<span>Punch</span></div>
          <div class="qr-top-id" id="topQrUserId"></div>
          <div class="qr-top-hint">Show to collect</div>
        </div>
        <div class="qr-canvas-container">
          <canvas id="topQrCanvas" width="94" height="94"></canvas>
        </div>
      </div>

      <!-- Guest Banner -->
      <div class="guest-banner" id="guestBanner">
        <div class="guest-banner-icon">!</div>
        <div class="guest-banner-text">
          <strong>Cards saved on this device only.</strong>
          <a href="#">Sign in</a> to keep them across devices.
        </div>
      </div>

      <!-- My Cards section -->
      <div class="section-header">
        <div class="section-title">My Cards</div>
        <div class="section-header-right">
          <button class="rewards-filter" id="rewardsFilter" onclick="toggleRewardsFilter()"></button>
          <div class="section-count" id="cardCount"></div>
        </div>
      </div>
      <div class="cards-list" id="cardsList"></div>
      <div class="empty-state" id="emptyState">
        <div class="empty-title">How it works</div>
        <div class="empty-steps">
          <div class="empty-step">
            <div class="empty-step-num">1</div>
            <div class="empty-step-text"><strong>Visit a shop</strong> that offers ePunch loyalty</div>
          </div>
          <div class="empty-step">
            <div class="empty-step-num">2</div>
            <div class="empty-step-text"><strong>Show your QR</strong> above to the cashier</div>
          </div>
          <div class="empty-step">
            <div class="empty-step-num">3</div>
            <div class="empty-step-text"><strong>Collect punches</strong> and earn free rewards</div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-view" id="tabHistory">
      <div class="section-header">
        <div class="section-title">Activity</div>
      </div>
      <div class="history-section" id="historyList"></div>
    </div>

    <!-- Profile Tab -->
    <div class="tab-view" id="tabProfile">
      <div class="section-header">
        <div class="section-title">Profile</div>
      </div>
      <div class="profile-section">
        <div class="profile-card">
          <div class="profile-avatar" id="profileAvatar"></div>
          <div class="profile-name" id="profileName"></div>
          <div class="profile-sub" id="profileSub"></div>
          <div class="profile-row">
            <span class="profile-row-label">User ID</span>
            <span class="profile-row-value" id="profileId"></span>
          </div>
          <div class="profile-row" id="profileEmailRow" style="display:none">
            <span class="profile-row-label">Email</span>
            <span class="profile-row-value" id="profileEmail"></span>
          </div>
          <div class="profile-row">
            <span class="profile-row-label">Status</span>
            <span class="profile-row-value" id="profileStatus">Guest</span>
          </div>
          <div class="profile-row">
            <span class="profile-row-label">Cards</span>
            <span class="profile-row-value" id="profileCardCount"></span>
          </div>
          <button class="profile-signin-btn" id="profileSigninBtn">Sign in to sync your cards</button>
        </div>
      </div>
    </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item active" data-tab="cards" onclick="switchTab('cards')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="3"/>
        <path d="M2 9h20"/>
        <path d="M7 21h10"/>
        <path d="M12 17v4"/>
      </svg>
      <span class="nav-label">Cards</span>
    </div>
    <div class="nav-item" data-tab="history" onclick="switchTab('history')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </svg>
      <span class="nav-label">History</span>
    </div>
    <div class="nav-item" data-tab="profile" onclick="switchTab('profile')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="8" r="4"/>
        <path d="M5 20c0-4 3.1-7 7-7s7 3 7 7"/>
      </svg>
      <span class="nav-label">Profile</span>
    </div>
  </div>
</div>

<!-- Card Detail Modal -->
<div class="modal-backdrop" id="detailModal">
  <div class="detail-sheet" id="detailContent"></div>
</div>

<!-- Redeem Modal -->
<div class="modal-backdrop" id="redeemModal">
  <div class="redeem-sheet" id="redeemContent"></div>
</div>

<script src="../data.js"></script>
<script>
var CARDS = APP_DATA.cards.map(function(c) {
  var base = { id: c.id, type: c.type, shop: c.shopName, address: c.address, program: c.program, accent: c.accent, emoji: c.emoji };
  if (c.type === 'punch') { base.current = c.current; base.total = c.total; base.reward = c.reward; base.ready = c.current >= c.total; }
  if (c.type === 'bundle') { base.remaining = c.remaining; base.total = c.total; }
  if (c.type === 'benefit') { base.status = c.status; base.benefitDesc = c.program; }
  return base;
});

function drawQR(canvas, seed, isRedeem) {
  var ctx = canvas.getContext('2d');
  var s = canvas.width;
  ctx.clearRect(0, 0, s, s);
  var grid = 25, cell = s / grid;
  var rng = function() { seed = (seed * 16807 + 0) % 2147483647; return seed / 2147483647; };
  for (var i = 0; i < 50; i++) rng();
  ctx.fillStyle = isRedeem ? '#FF385C' : '#222222';
  function finder(x, y) {
    ctx.fillRect(x * cell, y * cell, 7 * cell, 7 * cell);
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect((x + 1) * cell, (y + 1) * cell, 5 * cell, 5 * cell);
    ctx.fillStyle = isRedeem ? '#FF385C' : '#222222';
    ctx.fillRect((x + 2) * cell, (y + 2) * cell, 3 * cell, 3 * cell);
  }
  finder(0, 0); finder(grid - 7, 0); finder(0, grid - 7);
  for (var row = 0; row < grid; row++) {
    for (var col = 0; col < grid; col++) {
      if (col < 8 && row < 8) continue;
      if (col >= grid - 8 && row < 8) continue;
      if (col < 8 && row >= grid - 8) continue;
      if (rng() > 0.55) {
        ctx.fillRect(col * cell, row * cell, cell, cell);
      }
    }
  }
}

function hashId(str) {
  var h = 0;
  for (var i = 0; i < str.length; i++) h = ((h << 5) - h + str.charCodeAt(i)) | 0;
  return Math.abs(h);
}

function renderCards() {
  var list = document.getElementById('cardsList');
  list.innerHTML = '';
  var visibleCards = showingRewards ? rewardCards : CARDS;
  visibleCards.forEach(function(card) {
    var div = document.createElement('div');
    div.className = 'card-item' + (card.type === 'benefit' && card.status === 'expired' ? ' expired-card' : '');
    div.style.setProperty('--accent-color', card.accent);
    div.onclick = function() { openDetail(card.id); };

    var badgeClass = card.type === 'punch' ? 'badge-punch' : card.type === 'bundle' ? 'badge-bundle' : 'badge-benefit';
    var badgeText = card.type === 'punch' ? 'Punch' : card.type === 'bundle' ? 'Bundle' : 'Benefit';

    var html = '<div class="card-top">' +
      '<div class="card-emoji" style="background:' + card.accent + '15">' + card.emoji + '</div>' +
      '<div class="card-info"><div class="card-shop">' + card.shop + '</div>' +
      '<div class="card-program">' + card.program + '</div></div>' +
      '<div class="card-type-badge ' + badgeClass + '">' + badgeText + '</div></div>';

    if (card.type === 'punch') {
      var maxShow = Math.min(card.total, 12);
      html += '<div class="punch-progress">';
      for (var i = 0; i < maxShow; i++) {
        html += '<div class="punch-dot' + (i < card.current ? ' filled' : '') + '"' +
          (i < card.current ? ' style="background:' + card.accent + '"' : '') + '></div>';
      }
      if (card.total > 12) html += '<span class="punch-count">+' + (card.total - 12) + ' more</span>';
      html += '<span class="punch-count">' + card.current + '/' + card.total + '</span></div>';
      if (card.ready) html += '<div class="reward-badge">Reward ready</div>';
    }

    if (card.type === 'bundle') {
      var pct = (card.remaining / card.total * 100);
      html += '<div class="bundle-progress">' +
        '<div class="bundle-bar-wrap"><div class="bundle-bar"><div class="bundle-bar-fill" style="width:' + pct + '%;background:' + card.accent + '"></div></div>' +
        '<div class="bundle-label">' + card.remaining + ' of ' + card.total + ' remaining</div></div>' +
        '<div><div class="bundle-count" style="color:' + card.accent + '">' + card.remaining + '</div>' +
        '<div class="bundle-count-sub">left</div></div></div>';
    }

    if (card.type === 'benefit') {
      html += '<div class="benefit-desc">' + card.benefitDesc + '</div>' +
        '<div class="benefit-status ' + card.status + '"><div class="benefit-status-dot"></div>' +
        (card.status === 'active' ? 'Active' : 'Expired') + '</div>';
    }

    div.innerHTML = html;
    list.appendChild(div);
  });
  var showing = showingRewards ? rewardCards.length : CARDS.length;
  document.getElementById('cardCount').textContent = showing + ' cards';
  document.getElementById('emptyState').style.display = CARDS.length === 0 ? 'block' : 'none';
  document.getElementById('cardCount').style.display = CARDS.length === 0 ? 'none' : '';
}

var showingRewards = false;
var rewardCards = CARDS.filter(function(c) { return c.ready; });

function updateRewardsFilter() {
  var btn = document.getElementById('rewardsFilter');
  if (rewardCards.length === 0) {
    btn.classList.remove('visible');
    return;
  }
  btn.classList.add('visible');
  btn.textContent = showingRewards ? 'Show all' : 'Rewards (' + rewardCards.length + ')';
  btn.classList.toggle('active', showingRewards);
}

function toggleRewardsFilter() {
  showingRewards = !showingRewards;
  updateRewardsFilter();
  renderCards();
}

function openDetail(id) {
  var card = CARDS.find(function(c) { return c.id === id; });
  if (!card) return;
  var el = document.getElementById('detailContent');
  var html = '<div class="modal-handle"></div>' +
    '<div class="detail-header">' +
    '<div class="detail-emoji" style="background:' + card.accent + '15">' + card.emoji + '</div>' +
    '<div><div class="detail-shop">' + card.shop + '</div>' +
    '<div class="detail-address"><a href="https://maps.google.com/?q=' + encodeURIComponent(card.address) + '">' + card.address + ' \u2192</a></div></div></div>';

  html += '<div class="detail-section"><div class="detail-section-label">Program</div><div class="detail-program">' + card.program + '</div></div>';

  if (card.type === 'punch') {
    html += '<div class="detail-section"><div class="detail-section-label">Progress</div><div class="detail-progress-dots">';
    for (var i = 0; i < card.total; i++) {
      html += '<div class="detail-dot' + (i < card.current ? ' filled' : '') + '"' +
        (i < card.current ? ' style="background:' + card.accent + '"' : '') + '></div>';
    }
    html += '</div><div class="detail-progress-text">' + card.current + ' of ' + card.total + ' collected</div></div>';
    html += '<div class="detail-section"><div class="detail-section-label">Reward</div><div class="detail-reward">' + card.reward + '</div></div>';
    if (card.ready) html += '<button class="redeem-btn" onclick="openRedeem(\'' + card.id + '\')">Show QR to redeem</button>';
  }

  if (card.type === 'bundle') {
    var pct = card.remaining / card.total * 100;
    html += '<div class="detail-section"><div class="detail-section-label">Remaining Uses</div>' +
      '<div class="detail-bar"><div class="detail-bar-fill" style="width:' + pct + '%;background:' + card.accent + '"></div></div>' +
      '<div class="detail-progress-text">' + card.remaining + ' of ' + card.total + ' remaining</div></div>';
  }

  if (card.type === 'benefit') {
    html += '<div class="detail-section"><div class="detail-section-label">Benefit</div>' +
      '<div class="detail-benefit-text">' + card.benefitDesc + '</div>' +
      '<div class="benefit-status ' + card.status + '"><div class="benefit-status-dot"></div>' +
      (card.status === 'active' ? 'Active' : 'Expired') + '</div></div>';
  }

  html += '<button class="close-btn" onclick="closeDetail()">Close</button>';
  el.innerHTML = html;
  document.getElementById('detailModal').classList.add('visible');
}

function closeDetail() { document.getElementById('detailModal').classList.remove('visible'); }

function openRedeem(id) {
  closeDetail();
  var card = CARDS.find(function(c) { return c.id === id; });
  if (!card) return;
  var el = document.getElementById('redeemContent');
  el.innerHTML = '<div class="modal-handle"></div>' +
    '<div class="redeem-label">\u2605 Redemption Mode</div>' +
    '<div class="redeem-shop">' + card.shop + '</div>' +
    '<div class="redeem-reward">' + (card.reward || card.program) + '</div>' +
    '<div class="redeem-qr-wrap"><canvas id="redeemQrCanvas" width="180" height="180"></canvas></div>' +
    '<div class="redeem-warning">Show this QR code to the merchant to redeem your reward. Do not close until they confirm.</div>' +
    '<button class="redeem-cancel-btn" onclick="closeRedeem()">Cancel redemption</button>';
  document.getElementById('redeemModal').classList.add('visible');
  drawQR(document.getElementById('redeemQrCanvas'), hashId(card.id), true);
}

function closeRedeem() { document.getElementById('redeemModal').classList.remove('visible'); }

function switchTab(tab) {
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.querySelector('.nav-item[data-tab="' + tab + '"]').classList.add('active');
  document.querySelectorAll('.tab-view').forEach(function(v) { v.classList.remove('active'); });
  var tabMap = { cards: 'tabCards', history: 'tabHistory', profile: 'tabProfile' };
  document.getElementById(tabMap[tab]).classList.add('active');
  if (tab === 'history' && !document.getElementById('historyList').innerHTML) renderHistory();
  window.scrollTo(0, 0);
}

function renderHistory() {
  var container = document.getElementById('historyList');
  var groups = {};
  APP_DATA.feedEvents.forEach(function(ev) {
    if (!groups[ev.group]) groups[ev.group] = [];
    groups[ev.group].push(ev);
  });
  var html = '';
  Object.keys(groups).forEach(function(group) {
    html += '<div class="history-group-title">' + group + '</div>';
    groups[group].forEach(function(ev) {
      var card = APP_DATA.getCard(ev.cardId);
      if (!card) return;
      html += '<div class="history-item">' +
        '<div class="history-icon" style="background:' + card.accent + '12">' + card.emoji + '</div>' +
        '<div class="history-content">' +
        '<div class="history-text">' + APP_DATA.eventText(ev) + '</div>' +
        '<div class="history-time">' + ev.time + '</div></div></div>';
    });
  });
  container.innerHTML = html;
}

document.getElementById('detailModal').addEventListener('click', function(e) { if (e.target === this) closeDetail(); });
document.getElementById('redeemModal').addEventListener('click', function(e) { if (e.target === this) closeRedeem(); });

var isAuth = APP_DATA.user.authenticated;
document.getElementById('profileName').textContent = APP_DATA.user.name;
document.getElementById('profileSub').textContent = isAuth ? APP_DATA.user.email : 'Guest account \u2014 device only';
document.getElementById('profileId').textContent = APP_DATA.user.id;
document.getElementById('profileCardCount').textContent = CARDS.length;
document.getElementById('profileAvatar').textContent = APP_DATA.user.name.charAt(0).toUpperCase();
document.getElementById('profileStatus').textContent = isAuth ? 'Signed in' : 'Guest';
document.getElementById('profileSigninBtn').style.display = isAuth ? 'none' : '';
document.getElementById('guestBanner').style.display = isAuth ? 'none' : '';
if (isAuth && APP_DATA.user.email) {
  document.getElementById('profileEmail').textContent = APP_DATA.user.email;
  document.getElementById('profileEmailRow').style.display = '';
}
document.getElementById('topQrUserId').textContent = APP_DATA.user.id;
drawQR(document.getElementById('topQrCanvas'), APP_DATA.user.qrSeed, false);
renderCards();
updateRewardsFilter();
</script>
</body>
</html>
